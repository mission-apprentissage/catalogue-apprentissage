const { isValideUAI } = require("@mission-apprentissage/tco-service-node");
const { Formation } = require("../../../common/model");
const { runScript } = require("../../scriptWrapper");

/**
 * Lors du premier envoi vers PSUP, certaines formations sont revenues avec une erreur sur l'UAI lieu de formation ayant changé.
 * Ce script met à jour les formations avec les UAIs retournés par PSUP.
 */
const updateFormationUais = async () => {
  const toUpdate = {
    "100329P01211825002310002819900004300018-90010#L01": "0900004R",
    "100367P01211825002310002819900004300018-90010#L01": "0900004R",
    "087865P01211880086430002818800864300028-80021#L01": "0801327H",
    "018817P01211908000860002619080008600026-08105#L01": "0080008R",
    "107943P012X7758575010003277585750100032-30028#L01": "0300106C",
    "100357P01211300224520003613002245200036-16102#L01": "0161131T",
    "081073P01111880086430002818800864300028-80620#L01": "0800046R",
    "058475P01113932481900002639324819000026-78297#L01": "0781578S",
    "031464P01217757225720092977572257200929-16113#L01": "0161192J",
    "075789P01111880086430002818800864300028-02722#L01": "0022044L",
    "018817P01211859216160005719330018300012-62193#L01": "0624141P",
    "107905P01213904824200002839048242000028-35047#L01": "0352503F",
    "100561P01213495860990002134958609900021-55029#L01": "0551031X",
    "100361P01211972003300002919720033000029-72181#L01": "0720034W",
    "100357P01214129844940001041298449400010-78644#L01": "0783553N",
    "104239P01214129844940001041298449400010-78644#L01": "0783553N",
    "055797P01115001380290002942906702800077-59599#L01": "0592965C",
    "069319P01211964022000004819640220000048-64399#L01": "0641940L",
    "063736P01211964022000004819640220000048-64399#L01": "0641940L",
    "107905P01211894091050001318940910500013-94052#L01": "0940118T",
    "100367P01111880086430002818800864300028-80016#L01": "0800007Y",
    "082403P01214012061070006240120610700062-51649#L01": "0510062R",
    "100561P01213885594860007038855948600070-67388#L01": "0673020U",
    "018817P01213885594860007038855948600070-67118#L01": "0673018S",
    "082403P01213885594860007038855948600070-67118#L01": "0673018S",
    "100561P01213885594860007038855948600070-67118#L01": "0673018S",
    "100329P01213885594860007038855948600070-68258#L01": "0681801N",
    "100367P01111880086430002818800864300028-60471#L01": "0600040T",
    "083602P01111880086430002818800864300028-60471#L01": "0600040T",
    "083602P01211300172700082388930797100081-95500#L01": "0952262T",
    "106621P01311300172700082388930797100081-95500#L01": "0952262T",
    "106519P01213792416310005837924163100058-84007#L01": "0841037W",
    "104237P01214521194980002345211949800023-93073#L01": "0932046U",
    "107905P01211859216160005719590098000010-59291#L01": "0590098L",
    "100367P01211300279720013713002797200137-77288#L01": "0772884S",
    "104239P01211300279720013713002797200137-77288#L01": "0772884S",
    "106339P012X5026454760001650264547600016-74010#L01": "0741451A",
    "100329P01213904824200002839048242000028-35047#L01": "0352503F",
    "100563P01214115822810001941158228100019-69388#L01": "0690037R",
    "082786P01111880086430002818800864300028-02173#L01": "0020014E",
    "104239P01211880086430002818800864300028-60057#L01": "0600001A",
    "100561P01211880086430002818800864300028-02381#L01": "0020031Y",
    "083602P01111880086430002818800864300028-60157#L01": "0600013N",
    "018817P01211880086430002818800864300028-80001#L01": "0800001S",
    "100363P01111880086430002818800864300028-80021#L01": "0801882L",
    "075789P01111880086430002818800864300028-60057#L01": "0600002B",
    "075787P01111880086430002818800864300028-60057#L02": "0600002B",
    "087927P01111880086430002818800864300028-60463#L01": "0600020W",
    "087929P01111880086430002818800864300028-60463#L01": "0600020W",
    "087967P01111880086430002818800864300028-60463#L01": "0600020W",
    "104237P01211880086430002818800864300028-80620#L01": "0800046R",
    "107905P01213904824200002839048242000028-56121#L01": "0561949P",
    "094417P01213904824200002839048242000028-56121#L01": "0561949P",
    "100355P01213904824200002839048242000028-56121#L01": "0561949P",
    "100561P01213904824200002839048242000028-56121#L01": "0561949P",
    "069318P01211917008710001219170087100087-17415#L01": "0171401F",
    "064390P01211941001860001519410018600098-41003#L01": "0411065K",
    "089753P012X1913005320002219130053200022-13207#L01": "0130049H",
    "107905P01213904824200002839048242000028-29019#L01": "0292258X",
    "081375P01211951129660079919511296600799-51454#L01": "0511026N",
    "081476P01111880086430002818800864300028-02691#L01": "0020048S",
    "087937P01213510908400001535109084000015-33351#L01": "0333206F",
    "075792P01213510908400001535109084000056-33351#L01": "0333206F",
    "094415P01111880086430002818800864300028-80620#L01": "0800046R",
    "106339P01111880086430002818800864300028-02408#L02": "0020078Z",
    "081473P01111880086430002818800864300028-02691#L01": "0020048S",
    "087957P01211880086430002818800864300028-80021#L01": "0801194N",
    "088275P01213087085360005430870853600054-43137#L01": "0430058E",
    "087965P01211894091050001318940910500013-94016#L01": "0940580V",
    "083602P01213908949620005439089496200054-77083#L01": "0772468P",
    "080278P01213784388730005137843887300051-44162#L01": "0440333Y",
    "100329P01213904824200002839048242000028-56121#L01": "0561949P",
    "100561P01213510908400001535109084000015-33351#L01": "0333206F",
    "104239P02211880086430002818800864300028-02173#L01": "0020014E",
    "087933P01513381143090001033811430900010-16166#L01": "0161216K",
    "100329P01513381143090001033811430900010-17094#L01": "0171625Z",
    "075791P01213381143090001078128367600018-17094#L01": "0171625Z",
    "100563P01213381143090001078128367600018-17094#L01": "0171625Z",
    "082695P01111880086430002818800864300028-02722#L02": "0022044L",
    "037548P01113932481900002639324819000026-78297#L01": "0781578S",
    "100365P01111880086430002818800864300028-02408#L03": "0020032Z",
    "100367P01211806191990001118061919900011-83023#L01": "0830007G",
    "086604P01113885594860007038855948600070-67388#L01": "0673020U",
    "087965P01213885594860007038855948600070-68066#L01": "0682022D",
    "100561P01214012061070006240120610700039-08105#L01": "0080008R",
    "100357P01211880086430002818800864300028-02691#L01": "0020050U",
    "104237P012X4521194980002345211949800023-93073#L01": "0932343S",
    "045539P01114521194980002345211949800023-93073#L01": "0932343S",
    "100743P01111878091320004120006116600050-95210#L01": "0952196W",
    "087967P01211859216160005719590121000011-59350#L01": "0590121L",
    "100561P01211806191990001118061919900011-83126#L01": "0830923C",
    "083602P01211806191990001118061919900011-06088#L01": "0060033D",
    "100367P01211806191990001118061919900011-06088#L01": "0060033D",
    "100357P01211806191990001118061919900011-06088#L01": "0060029Z",
    "094731P01314397428750002443974287500024-68224#L01": "0681847N",
    "094733P01314851828360002678644691400115-85191#L01": "0851637T",
    "094735P01314397428750002443974287500024-68224#L01": "0681847N",
    "020893P01111971106870006219711068700062-71202#L01": "0711068A",
    "020881P01111964022000004819640220000048-64430#L01": "0642045A",
    "094731P01314397428750002443974287500024-67482#L01": "0671555B",
    "104285P011X1934012880006619340128800066-34199#L01": "0341621C",
    "093225P01111953008190001619530081900016-53130#L01": "0530909A",
    "106907P01111844013540005730256516300011-85109#L01": "0492220X",
    "020872P01111844013540005730256516300011-85109#L01": "0492351P",
    "020885P01111844013540005739944518800028-49328#L01": "0492351P",
    "082776P01211910002560003919100025600039-10325#L01": "0100022V",
    "093217P01211947001910003519470019100035-47324#L01": "0470943V",
    "104237P01113054050450195730540504501957-69013#L01": "0690553B",
    "094733P01318933734230001930293883200045-26362#L01": "0261429M",
    "094731P01314397428750002443974287500024-51454#L01": "0511556P",
    "094735P01314397428750002443974287500024-51454#L01": "0511556P",
    "094733P01314397428750002443974287500024-51454#L01": "0511556P",
    "094735P01314397428750002443974287500024-67482#L01": "0672684D",
    "094733P01314397428750002443974287500024-67482#L01": "0671555B",
    "094731P01314918847300004679296161700018-35238#L01": "0351603R",
    "094735P01314918847300004679296161700018-35238#L01": "0351603R",
    "094733P01314918847300004679296161700018-35238#L01": "0351603R",
    "106517P01211806191990001118061919900011-83137#L01": "0831243A",
    "082792P01213784388730005137843887300051-44162#L01": "0440333Y",
    "075789P01211944002970002519440029700025-44109#L01": "0440029T",
    "075787P01211944002970002519440029700025-44109#L01": "0440029T",
    "094735P01318933734230001930293883200045-26362#L01": "0261429M",
    "084989P01211922005820002619220083000011-22113#L01": "0222026H",
    "083602P01211911002390002619110023900026-11262#L01": "0110023R",
    "106517P01211806191990001118061919900011-06088#L01": "0060033D",
    "100363P01211806191990001118061919900011-06069#L01": "0060023T",
    "087941P01211300237400043913002374000199-62041#L01": "0622309Y",
    "100357P01225176797420003451767974200034-75117#L01": "0755902H",
    "018840P01211935003030003019350030300030-35288#L01": "0352899L",
    "106339P012X4521194980002345211949800023-93073#L01": "0932343S",
    "100365P012X4521194980002345211949800023-93073#L01": "0932343S",
    "094737P01314918847300004679296161700018-35238#L01": "0351603R",
    "100367P01117756881040006377568810400063-69388#L01": "0690642Y",
    "077615P01111880086430002818800864300028-60141#L02": "0601845E",
    "100367P01214129844940001041298449400010-78644#L01": "0783553N",
    "100357P01211806191990001118061919900011-83023#L01": "0830007G",
    "100363P01211806191990001118061919900011-83137#L01": "0831453D",
    "075789P01211806191990001118061919900011-06004#L01": "0061478Z",
    "110507P01211806191990001118061919900011-06004#L01": "0061478Z",
    "100563P01211806191990001118061919900011-06004#L01": "0061478Z",
    "094415P01115001380290002934012780200015-59017#L01": "0593060F",
    "087941P01211908000860002619080008600026-08409#L01": "0080047H",
    "104237P01213792416310005837924163100058-84007#L01": "0840077C",
    "094737P01314397428750002443974287500024-51454#L01": "0511556P",
    "100367P01217803484880001378034848800054-10387#L01": "0100059K",
    "104239P01217803484880001378034848800054-10387#L01": "0100059K",
    "100357P01217803484880001378034848800054-10387#L01": "0100059K",
    "104237P01217803484880001378034848800054-10387#L01": "0100059K",
    "106517P01217803484880001378034848800054-10387#L01": "0100059K",
    "055086P01214444720210001348825428500015-85238#L01": "0850086G",
    "080278P01214444720210001348825428500015-85238#L01": "0850086G",
    "077615P01215030492150002650304921500026-01071#L01": "0010878Z",
    "087941P01218208152800001282081528000012-35051#L01": "0350793X",
    "107905P01218208152800001282081528000012-35051#L01": "0350793X",
    "100561P01218208152800001282081528000012-35051#L01": "0350793X",
    "087939P01218208152800001282081528000012-35051#L01": "0350793X",
    "106339P01211806191990001118061919900011-83137#L01": "0831453D",
    "077192P01211935003030003019350030300030-35115#L01": "0350761M",
    "083602P012X1933002330003119330028200012-33063#L01": "0330028B",
    "100367P012X3039695960003830396959600038-69115#L01": "0690553B",
    "107905P01211969286670002719692866700027-69385#L01": "0690128P",
    "083602P01211894091050001318940910500013-94028#L01": "0940114N",
    "075787P012X4839574780001748395747800017-11076#L01": "0110012D",
    "018894P01213510908400001535109084000056-33351#L01": "0333206F",
    "100357P01211806191990001118061919900011-83137#L01": "0830053G",
    "073434P01217807475490001978074754900019-14396#L01": "0142270S",
    "093637P01113904824200002839048242000028-29051#L01": "0292338J",
    "094091P01113904824200002839048242000028-29051#L01": "0292338J",
    "080278P01211300279720013713002797200137-77288#L01": "0772884S",
    "100561P01214109366450004441093664500044-29051#L01": "0292341M",
    "100561P01214109366450004419220058200026-22093#L01": "0222033R",
    "110507P01211806191990001118061919900011-83069#L01": "0831014B",
    "104239P01218033555930003680335559300036-68062#L01": "0681885E",
    "083602P01211825002310002819390019800014-39300#L01": "0390019J",
    "087939P01213944545160002934835568600133-25056#L01": "0251592V",
    "087933P01213141869820003431418698200034-71076#L01": "0212001L",
    "018894P012X1933002330003119470003500018-47001#L01": "0470003Y",
    "100363P01211886090770005518860907700055-86194#L01": "0861419A",
    "088277P01211880086430002818800864300028-02173#L01": "0020014E",
    "104239P01211880086430002818800864300028-02691#L01": "0020049T",
    "081073P01211880086430002818800864300028-02307#L01": "0020025S",
    "094415P01211880086430002818800864300028-02307#L01": "0020025S",
    "104239P01218079361170004180793611700041-10387#L01": "0101141L",
    "083602P01211935003030003019350030300030-35238#L01": "0352996S",
    "083144P01218925840790001678095858300046-61189#L01": "0611020C",
    "082776P012X1831090730003519650026800012-66136#L01": "0650026A",
    "107917P01211894091050001318940910500013-94016#L01": "0771027Y",
    "087941P012X1933002330003119240026500018-24322#L01": "0400049L",
    "104237P01111942004240002719420042400027-42187#L01": "0420034J",
    "082787P01211859216160005719590121000011-59350#L01": "0590121L",
    "087941P01218189081880001981890818800035-51454#L01": "0511146U",
    "100561P01218189081880001981890818800035-51454#L01": "0511146U",
    "075943P01211925120280001519251202800015-25364#L01": "0251853D",
    "100365P01215030492150002677947062400023-26362#L01": "0260074P",
    "020893P01111964022000004819640220000030-64399#L01": "0641940L",
    "100357P01115001380290002942906702800077-59599#L01": "0592965C",
    "083144P01111969025060005019010819100015-01053#L01": "0011444P",
    "069312P01111969025060005019010819100015-01053#L01": "0011444P",
    "063736P01111969025060005019010819100015-01053#L01": "0011444P",
    "020872P01111969025060005019010819100015-01053#L01": "0011444P",
    "094731P01318933734230001930293883200045-26362#L01": "0261429M",
    "110267P01111949096360005319490946100015-49331#L01": "0492389F",
    "104285P01111949096360005319490946100015-49278#L01": "0492389F",
    "082787P01211975071220004619750712200046-75114#L01": "0750691U",
    "107917P01214521194980002345211949800023-93073#L01": "0932343S",
    "106905P01117836262600001378362626000013-50341#L01": "0501578U",
    "077615P01218033555930003680335559300036-68062#L01": "0681885E",
    "106339P01218033555930003680335559300036-68376#L01": "0681917P",
    "109049P01115052284860004750522848600047-13001#L01": "0133944S",
    "087965P01213141869820003431418698200034-21231#L01": "0212001L",
    "109803P01217757225720092977572257200929-16113#L01": "0161192J",
    "053280P01217757225720092977572257200929-16113#L01": "0161192J",
    "106905P01111969025060005019010819100015-01053#L01": "0011444P",
    "104239P01211806191990001118061919900011-06088#L01": "0060029Z",
    "083602P01211821002630004118210026300041-21231#L01": "0890005X",
    "104239P02211880086430002818800864300028-80021#L01": "0801628K",
    "053410P01211806191990001118061919900011-83137#L01": "0831243A",
    "083602P01211806191990001118061919900011-83137#L01": "0831243A",
    "094419P01211806191990001118061919900011-83062#L01": "0831407D",
    "082403P01213932481900002639324819000026-78440#L01": "0781984H",
    "077615P01211806191990001118061919900011-06088#L01": "0060029Z",
    "100357P01211931001790003819310017900038-31483#L01": "0651106Z",
    "100363P01211880086430002818800864300028-60338#L01": "0601863Z",
    "100561P012X1933002330003119330023300031-40088#L01": "0400007R",
    "104239P01213898023560004538980235600045-47323#L01": "0471027L",
    "100367P01211876090940002919760096800014-76451#L01": "0762624P",
    "083602P01211876090940002919760096800022-76540#L01": "0760096S",
    "106621P01211876090940002919760096800022-76540#L01": "0760096S",
    "104239P01211880086430002818800864300028-60157#L01": "0600013N",
    "093637P01113904824200002839048242000028-56121#L01": "0561949P",
    "093637P01113904824200002839048242000028-35360#L01": "0352927S",
    "094091P01113904824200002839048242000028-35360#L01": "0352927S",
    "106339P01218778455370001987784553700019-13004#L01": "0134349G",
    "104239P01218778455370001987784553700019-13004#L01": "0134349G",
    "087937P01218778455370001987784553700019-13004#L01": "0134349G",
    "100367P01218778455370001987784553700019-13004#L01": "0134349G",
    "100367P012X4208472460020442084724600204-92062#L01": "0922752S",
    "106339P012X1831090730003519650026800012-66136#L01": "0650026A",
    "104239P01214241754610002142417546100021-85191#L01": "0851699K",
    "082402P012X8832547320001888325473200018-34172#L01": "0342456K",
    "100357P012X8832547320001888325473200018-34172#L01": "0342456K",
    "077615P012X8832547320001888325473200018-34172#L01": "0342456K",
    "087931P01214496770870001644967708700016-67482#L01": "0672790U",
    "054459P01214496770870001644967708700016-67482#L01": "0672790U",
    "053410P01214496770870001644967708700016-67482#L01": "0672790U",
    "018840P01214496770870001644967708700016-67482#L01": "0672790U",
    "104239P01214432006130002644320061300026-35238#L01": "0353052C",
    "100367P012X8832547320001888325473200018-34032#L01": "0342456K",
    "104239P012X4382169130003043821691300030-71076#L01": "0711937V",
    "100365P01214085601180001540856011800015-13206#L01": "0134137B",
    "100357P01214933005600001549330056000015-64371#L01": "0640124M",
    "098569P01213215923540012032159235400120-68295#L01": "0682091D",
    "077615P01111880086430002818800864300028-80021#L02": "0801882L",
    "100367P01211806191990001118061919900011-06083#L01": "0060026W",
    "106517P01218049344120002980493441200029-75111#L01": "0756248J",
    "022298P01111946049060004119460490600041-46143#L01": "0460745K",
    "053410P012X5378345330001153783453300011-71342#L01": "0711755X",
    "100365P01211886090770005518860907700055-79191#L01": "0170028N",
    "100743P01211886090770005518860907700055-16292#L01": "0861419A",
    "077192P01211880086430002818800864300028-60175#L01": "0600021X",
    "086604P01111880086430002818800864300028-02691#L01": "0020079A",
    "083602P01214432006130002644320061300026-35238#L01": "0353052C",
    "087941P01211806000170001618060001700016-06088#L01": "0062204N",
    "104239P01211880086430002818800864300028-60176#L01": "0601832R",
    "104239P01211880086430002818800864300028-60338#L01": "0601863Z",
    "018910P012X1934004210002319341385300014-34172#L01": "0341540P",
    "087939P01212000463240002220004632400022-07066#L01": "0070009X",
    "107929P01214101225430002941012254300029-75113#L01": "0750685M",
    "081408P01211960178260001319622257400010-62817#L01": "0622257S",
    "069319P01211960178260001319622257400010-62817#L01": "0622257S",
    "020881P01111960178260001319622257400010-62817#L01": "0622257S",
    "081074P01218033555930003680335559300036-68062#L01": "0681885E",
    "107905P01214012061070006240120610700062-51454#L01": "0510034K",
    "086604P01111886090770005518860907700055-86194#L01": "0860823C",
    "094101P01113904824200002839048242000028-29019#L01": "0292258X",
    "086604P01111876090940002919270042500023-27679#L01": "0271319M",
    "108195P01314432006130002644320061300026-35238#L01": "0353052C",
    "107837P01314432006130002644320061300026-35238#L01": "0353052C",
    "081475P01211880086430002818800864300028-02691#L01": "0020048S",
    "100357P01217799625130001577996251300015-57630#L01": "0570294K",
    "110865P01211976131510001219761315100012-76451#L01": "0763418C",
    "112855P01218907914290001689079142900172-30007#L01": "0301645A",
    "081408P01217836262600001378362626000013-51569#L01": "0511645L",
    "064390P01217836262600001378362626000013-51569#L01": "0511645L",
    "107839P01314432006130002644320061300026-35238#L01": "0353052C",
    "109271P01314432006130002644320061300026-35238#L01": "0353052C",
    "110237P01217842808020001778428080200025-06088#L01": "0752792C",
    "104239P01211910002560003919100025600039-10325#L01": "0100022V",
    "094419P01211910002560003919100025600039-10325#L01": "0100022V",
    "053410P01211880086430002818800864300028-02173#L01": "0020014E",
    "112048P01313910324890001839103248900018-75108#L01": "0756266D",
    "087933P01213904824200002839048242000028-29019#L01": "0292258X",
    "087967P01213904824200002839048242000028-29019#L01": "0292258X",
    "100329P01213904824200002839048242000028-29019#L01": "0292258X",
    "104239P012X8907914290001689079142900149-30156#L01": "0301286K",
    "100563P01211934004210002319340042100015-34172#L01": "0340042L",
    "019005P01211300228090011013002280900136-35115#L01": "0351883G",
    "100365P01211825002310002819390019800014-39300#L01": "0390019J",
    "078104P012X1969025060005019421088600017-42180#L01": "0422327B",
    "100367P01211300206880001113002068800045-44184#L01": "0442631W",
    "104239P01214241754610002142417546100021-44184#L01": "0442632X",
    "100357P01214241754610002142417546100021-44184#L01": "0442632X",
    "087967P01214012061070006240120610700062-51108#L01": "0510007F",
    "100357P01215092328310001650923283100016-51108#L01": "0511951U",
    "069312P01211953008190001619530081900016-53130#L01": "0530909A",
    "110003P01311300155060001213001550600012-57463#L01": "0570175F",
    "110027P01311300155060001213001550600012-57463#L01": "0570175F",
    "082783P01211859216160005719590121000011-59350#L01": "0590121L",
    "089753P01211859216160005719590121000011-59350#L01": "0590121L",
    "100357P01211880086430002818800864300028-60157#L01": "0600013N",
    "069312P01211971106870006219711068700062-71202#L01": "0711068A",
    "069319P01211971106870006219711068700062-71202#L01": "0711068A",
    "087933P012X3525011590001135250115900011-71342#L01": "0711755X",
    "073432P01211976131510001219761315100012-76451#L01": "0763418C",
    "069318P01211976131510001219761315100012-76451#L01": "0763418C",
    "081408P01211976131510001219761315100012-76451#L01": "0763418C",
    "087967P012X1894091050001318940910500013-77337#L01": "0771940R",
  };

  let [ok, ko] = [0, 0];

  for (let [cle_ministere_educatif, uai_formation] of Object.entries(toUpdate)) {
    try {
      if (!isValideUAI(uai_formation)) {
        throw `UAI invalide : ${uai_formation}`;
      }

      const formation = await Formation.findOne({ cle_ministere_educatif });

      const editedFields = { ...formation.editedFields, uai_formation };
      const updates_history = [
        ...formation.updates_history,
        {
          from: {
            uai_formation: formation.uai_formation,
          },
          to: {
            uai_formation,
            last_update_who: "Parcoursup",
          },
          updated_at: new Date(),
        },
      ];

      await Formation.updateOne({ cle_ministere_educatif }, { uai_formation, updates_history, editedFields });
      ok++;
    } catch (err) {
      console.error(err);
      ko++;
    }
  }

  console.log({ ok, ko });
};

module.exports = updateFormationUais;

if (process.env.standalone) {
  runScript(async () => await updateFormationUais());
}
